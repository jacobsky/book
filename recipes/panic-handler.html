<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Rust panic handler - The godot-rust Book</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../getting-started.html"><strong aria-hidden="true">2.</strong> Getting Started</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../getting-started/setup.html"><strong aria-hidden="true">2.1.</strong> Setup</a></li><li class="chapter-item expanded "><a href="../getting-started/hello-world.html"><strong aria-hidden="true">2.2.</strong> Hello, world!</a></li></ol></li><li class="chapter-item expanded "><a href="../gdnative-overview.html"><strong aria-hidden="true">3.</strong> An Overview of GDNative</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../gdnative-overview/data-representations.html"><strong aria-hidden="true">3.1.</strong> Data representations</a></li><li class="chapter-item expanded "><a href="../gdnative-overview/wrappers.html"><strong aria-hidden="true">3.2.</strong> Ref, TRef and Instance</a></li><li class="chapter-item expanded "><a href="../gdnative-overview/architecture.html"><strong aria-hidden="true">3.3.</strong> Game architecture</a></li></ol></li><li class="chapter-item expanded "><a href="../rust-binding.html"><strong aria-hidden="true">4.</strong> Binding to Rust code</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../rust-binding/classes.html"><strong aria-hidden="true">4.1.</strong> Class registration</a></li><li class="chapter-item expanded "><a href="../rust-binding/methods.html"><strong aria-hidden="true">4.2.</strong> Exported methods</a></li><li class="chapter-item expanded "><a href="../rust-binding/properties.html"><strong aria-hidden="true">4.3.</strong> Exported properties</a></li><li class="chapter-item expanded "><a href="../rust-binding/to-variant-from-variant-export.html"><strong aria-hidden="true">4.4.</strong> ToVariant, FromVariant and Export</a></li><li class="chapter-item expanded "><a href="../rust-binding/calling-gdscript.html"><strong aria-hidden="true">4.5.</strong> Calling into GDScript from Rust</a></li></ol></li><li class="chapter-item expanded "><a href="../faq.html"><strong aria-hidden="true">5.</strong> FAQ</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../faq/code.html"><strong aria-hidden="true">5.1.</strong> Common code questions</a></li><li class="chapter-item expanded "><a href="../faq/multithreading.html"><strong aria-hidden="true">5.2.</strong> Multithreading</a></li><li class="chapter-item expanded "><a href="../faq/configuration.html"><strong aria-hidden="true">5.3.</strong> Configuration</a></li><li class="chapter-item expanded "><a href="../faq/support.html"><strong aria-hidden="true">5.4.</strong> Versioning and supported platforms</a></li><li class="chapter-item expanded "><a href="../faq/community.html"><strong aria-hidden="true">5.5.</strong> Community</a></li><li class="chapter-item expanded "><a href="../faq/godot4.html"><strong aria-hidden="true">5.6.</strong> Godot 4.0 Status</a></li></ol></li><li class="chapter-item expanded "><a href="../testing.html"><strong aria-hidden="true">6.</strong> (TODO) Testing</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../testing/structure.html"><strong aria-hidden="true">6.1.</strong> Structuring code for testing</a></li><li class="chapter-item expanded "><a href="../testing/engine.html"><strong aria-hidden="true">6.2.</strong> Testing with the engine</a></li></ol></li><li class="chapter-item expanded "><a href="../recipes.html"><strong aria-hidden="true">7.</strong> Recipes</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../recipes/async-tokio.html"><strong aria-hidden="true">7.1.</strong> Async with Tokio runtime</a></li><li class="chapter-item expanded "><a href="../recipes/custom-node-plugin.html"><strong aria-hidden="true">7.2.</strong> Custom node plugin</a></li><li class="chapter-item expanded "><a href="../recipes/external-resources.html"><strong aria-hidden="true">7.3.</strong> Loading external resources</a></li><li class="chapter-item expanded "><a href="../recipes/logging.html"><strong aria-hidden="true">7.4.</strong> Logging</a></li><li class="chapter-item expanded "><a href="../recipes/nix-build-system.html"><strong aria-hidden="true">7.5.</strong> Nix as development environment</a></li><li class="chapter-item expanded "><a href="../recipes/panic-handler.html" class="active"><strong aria-hidden="true">7.6.</strong> Rust panic handler</a></li></ol></li><li class="chapter-item expanded "><a href="../projects.html"><strong aria-hidden="true">8.</strong> Third-party projects</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../projects/games.html"><strong aria-hidden="true">8.1.</strong> Games</a></li><li class="chapter-item expanded "><a href="../projects/tools.html"><strong aria-hidden="true">8.2.</strong> Tools and integrations</a></li><li class="chapter-item expanded "><a href="../projects/applications.html"><strong aria-hidden="true">8.3.</strong> Applications</a></li></ol></li><li class="chapter-item expanded "><a href="../exporting.html"><strong aria-hidden="true">9.</strong> Exporting</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../exporting/android.html"><strong aria-hidden="true">9.1.</strong> Android</a></li><li class="chapter-item expanded "><a href="../exporting/ios.html"><strong aria-hidden="true">9.2.</strong> (TODO) iOS</a></li><li class="chapter-item expanded "><a href="../exporting/macosx.html"><strong aria-hidden="true">9.3.</strong> Mac OS X</a></li></ol></li><li class="chapter-item expanded "><a href="../advanced-guides.html"><strong aria-hidden="true">10.</strong> Advanced Guides</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../advanced-guides/custom-godot.html"><strong aria-hidden="true">10.1.</strong> Using custom Godot versions</a></li><li class="chapter-item expanded "><a href="../advanced-guides/migrating-0-8.html"><strong aria-hidden="true">10.2.</strong> Migrating from godot-rust 0.8</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The godot-rust Book</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="recipe-rust-panic-handler"><a class="header" href="#recipe-rust-panic-handler">Recipe: Rust panic handler</a></h1>
<p>When using GDNative, Rust panics are ignored by Godot by default. This recipe can be used to catch those panics in the Godot editor at runtime.</p>
<p>This recipe was written and tested with godot-rust 0.9.3 with Rust version 1.52.1</p>
<h2 id="gdscript-hook"><a class="header" href="#gdscript-hook">GDScript hook</a></h2>
<p>First create a GDScript with the following code named &quot;rust_panic_hook.gd&quot;</p>
<pre><code>extends Node

func rust_panic_hook(error_msg: String) -&gt; void:
	assert(false, error_msg)

</code></pre>
<p>In the Project Settings -&gt; Autoload menu, create an autoload singleton referencing the script (in this case rust_panic_hook.gd).</p>
<p>Pick a unique name that identifies the autoload singleton. You will need to use this name to find the autoload singleton in Rust.</p>
<p>For this example, we are using the autoload name &quot;rust_panic_hook&quot;.</p>
<p>At this point we have our GDScript based  panic hook we can use in Rust.</p>
<h2 id="gdnative-hook-initialization"><a class="header" href="#gdnative-hook-initialization">GDNative hook initialization</a></h2>
<p>In the GDNative library code's entry point (lib.rs by default).</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub fn init_panic_hook() {
    // To enable backtrace, you will need the `backtrace` crate to be included in your cargo.toml, or 
    // a version of Rust where backtrace is included in the standard library (e.g. Rust nightly as of the date of publishing)
    // use backtrace::Backtrace;
    // use std::backtrace::Backtrace;
    let old_hook = std::panic::take_hook();
    std::panic::set_hook(Box::new(move |panic_info| {
        let loc_string;
        if let Some(location) = panic_info.location() {
            loc_string = format!(&quot;file '{}' at line {}&quot;, location.file(), location.line());
        } else {
            loc_string = &quot;unknown location&quot;.to_owned()
        }

        let error_message;
        if let Some(s) = panic_info.payload().downcast_ref::&lt;&amp;str&gt;() {
            error_message = format!(&quot;[RUST] {}: panic occurred: {:?}&quot;, loc_string, s);
        } else if let Some(s) = panic_info.payload().downcast_ref::&lt;String&gt;() {
            error_message = format!(&quot;[RUST] {}: panic occurred: {:?}&quot;, loc_string, s);
        } else {
            error_message = format!(&quot;[RUST] {}: unknown panic occurred&quot;, loc_string);
        }
        godot_error!(&quot;{}&quot;, error_message);
        // Uncomment the following line if backtrace crate is included as a dependency
        // godot_error!(&quot;Backtrace:\n{:?}&quot;, Backtrace::new());
        (*(old_hook.as_ref()))(panic_info);

        unsafe {
            if let Some(gd_panic_hook) = gdnative::api::utils::autoload::&lt;gdnative::api::Node&gt;(&quot;rust_panic_hook&quot;) {
                gd_panic_hook.call(&quot;rust_panic_hook&quot;, &amp;[GodotString::from_str(error_message).to_variant()]);
            }
        }
    }));
}
<span class="boring">}
</span></code></pre></pre>
<p>The details the process in the above code is as follows:</p>
<ol>
<li>Get the default panic hook from Rust</li>
<li>Create a new panic hook closure to output to the Godot console</li>
<li>Get the location string and error message from the <code>panic_info</code> closure parameter and print the message to the console</li>
<li>Optionally, retreive and print the backtrace</li>
<li>Execute the old panic hook so that the normal panic behavior still occurs</li>
<li>Call the function defined on your GDScript panic hook script</li>
</ol>
<p>The final step is to call <code>init_panic_hook()</code> at the end of the <code>init</code> function that you pass in the <code>godot_init(init)</code> macro such as in the following code.</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// GDNative entry point
fn init(handle: InitHandle) {
    // -- class registration above
    init_panic_hook();
}
<span class="boring">}
</span></code></pre></pre>
<p>Now you can run your game and once it is fully initialized, any panics will pause the game execution and print the panic message in Godot's editor in the Debugger's Error tab.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../recipes/nix-build-system.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../projects.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../recipes/nix-build-system.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../projects.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
